apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: default
spec:
  replicas: 3  # 3副本分布在3个node
  selector: { matchLabels: { app: nginx } }
  template:
    metadata: { labels: { app: nginx } }
    spec:
      imagePullSecrets: [{ name: harbor-registry-secret }]  # 拉取Harbor镜像
      containers:
      - name: nginx
        image: harbor.test.com/library/nginx:latest
        ports: [{ containerPort: 80 }]
        volumeMounts:
        - name: welcome-page  # 挂载欢迎页CM
          mountPath: /usr/share/nginx/html
        - name: accesslog     # 挂载PVC存日志
          mountPath: /var/log/nginx
        resources:  # 资源限制
          limits: { cpu: 500m, memory: 512Mi }
          requests: { cpu: 200m, memory: 256Mi }
      volumes:
      - name: welcome-page
        configMap: { name: welcome-nginx-cm, items: [{ key: index.html, path: index.html }] }
      - name: accesslog
        persistentVolumeClaim: { claimName: nginx-accesslog-pvc }
      # 反亲和性：确保副本分布在不同node
      #affinity:
      #  podAntiAffinity:
      #    requiredDuringSchedulingIgnoredDuringExecution:
      #    - labelSelector: { matchExpressions: [{ key: app, operator: In, values: [nginx] }] }
      #      topologyKey: kubernetes.io/hostname
